{% extends 'base.html' %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row">
        <div class="col-12">
            <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ –∏ –∫–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h1>üìä –†–µ–¥–∞–∫—Ç–æ—Ä Excel</h1>
                    <p class="text-muted">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–º–ø–ª–µ–∫—Ç–∞—Ü–∏–∏ –¥–ª—è –∑–∞–ø–∏—Å–∏ #{{ record_id }}</p>
                </div>
                <div>
                    <a href="{% url 'record_detail' record_id %}" class="btn btn-secondary">
                        ‚Üê –ù–∞–∑–∞–¥ –∫ –∑–∞–ø–∏—Å–∏
                    </a>
                </div>
            </div>

            <!-- –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è -->
            <div class="card mb-4">
                <div class="card-body">
                    <div class="d-flex gap-2 flex-wrap">
                        <button id="load-btn" class="btn btn-primary">
                            <i class="bi bi-arrow-repeat"></i> –ó–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ
                        </button>
                        <button id="save-btn" class="btn btn-success">
                            <i class="bi bi-floppy"></i> –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
                        </button>
                        <button id="download-btn" class="btn btn-info">
                            <i class="bi bi-download"></i> –°–∫–∞—á–∞—Ç—å Excel
                        </button>
                        <span id="save-status" class="badge bg-secondary align-self-center">
                            –ù–µ –∑–∞–≥—Ä—É–∂–µ–Ω–æ
                        </span>
                    </div>
                </div>
            </div>

            <!-- –û–±–ª–∞—Å—Ç—å –∑–∞–≥—Ä—É–∑–∫–∏ -->
            <div id="loading" class="text-center py-5" style="display: none;">
                <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status">
                    <span class="visually-hidden">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
                </div>
                <p class="mt-3">–ó–∞–≥—Ä—É–∑–∫–∞ Excel —Ñ–∞–π–ª–∞...</p>
            </div>

            <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —Ç–∞–±–ª–∏—Ü—ã -->
            <div id="excel-container" class="card" style="display: none;">
                <div class="card-body p-0">
                    <div id="hot"></div>
                </div>
            </div>

            <!-- –°–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö -->
            <div id="error-message" class="alert alert-danger mt-3" style="display: none;"></div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
let hot;
const recordId = {{ record_id }};
let isDataLoaded = false;

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è CSRF —Ç–æ–∫–µ–Ω–∞
function getCSRFToken() {
    const cookies = document.cookie.split(';');
    for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.startsWith('csrftoken=')) {
            return cookie.substring('csrftoken='.length);
        }
    }
    return '';
}

// –ü–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å —ç–ª–µ–º–µ–Ω—Ç—ã
function showElement(id, show) {
    document.getElementById(id).style.display = show ? 'block' : 'none';
}

// –ü–æ–∫–∞–∑–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ
function showError(message) {
    const errorElement = document.getElementById('error-message');
    errorElement.textContent = message;
    errorElement.style.display = 'block';
}

// –°–∫—Ä—ã—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ
function hideError() {
    document.getElementById('error-message').style.display = 'none';
}

// –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å
function updateStatus(text, type = 'secondary') {
    const statusElement = document.getElementById('save-status');
    statusElement.textContent = text;
    statusElement.className = `badge bg-${type} align-self-center`;
}

// –ó–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ Excel
async function loadExcelData() {
    try {
        showElement('loading', true);
        showElement('excel-container', false);
        hideError();
        updateStatus('–ó–∞–≥—Ä—É–∑–∫–∞...', 'info');

        const response = await fetch(`/record/${recordId}/excel-data/`);
        const data = await response.json();

        showElement('loading', false);

        if (data.success) {
            initHandsontable(data.data);
            showElement('excel-container', true);
            isDataLoaded = true;
            updateStatus('–î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã', 'success');
        } else {
            showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
            updateStatus('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏', 'danger');
        }
    } catch (error) {
        showElement('loading', false);
        showError('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + error.message);
        updateStatus('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏', 'danger');
        console.error('Error:', error);
    }
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å Handsontable
function initHandsontable(data) {
    const container = document.getElementById('hot');

    // –£–¥–∞–ª—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π —ç–∫–∑–µ–º–ø–ª—è—Ä –µ—Å–ª–∏ –µ—Å—Ç—å
    if (hot) {
        hot.destroy();
    }

    // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π —ç–∫–∑–µ–º–ø–ª—è—Ä
    hot = new Handsontable(container, {
        data: data,
        rowHeaders: true,
        colHeaders: true,
        height: 600,
        width: '100%',
        licenseKey: 'non-commercial-and-evaluation',
        contextMenu: true,
        manualColumnResize: true,
        manualRowResize: true,
        columnSorting: true,
        stretchH: 'all',
        afterChange: function() {
            if (isDataLoaded) {
                updateStatus('–ù–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ', 'warning');
            }
        }
    });
}

// –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –¥–∞–Ω–Ω—ã–µ
async function saveExcelData() {
    if (!hot || !isDataLoaded) {
        alert('–°–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∑–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ');
        return;
    }

    try {
        updateStatus('–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...', 'info');

        const data = hot.getData();
        const csrfToken = getCSRFToken();

        const response = await fetch(`/record/${recordId}/save-excel/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({ data: data })
        });

        const result = await response.json();

        if (result.success) {
            updateStatus('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ', 'success');
            alert('‚úÖ –î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!');
        } else {
            updateStatus('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è', 'danger');
            alert('‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ' + (result.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
        }
    } catch (error) {
        updateStatus('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏', 'danger');
        alert('‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏');
        console.error('Error:', error);
    }
}

// –°–∫–∞—á–∞—Ç—å Excel —Ñ–∞–π–ª
function downloadExcel() {
    if (!isDataLoaded) {
        alert('–°–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∑–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ');
        return;
    }

    window.open(`/record/${recordId}/download-excel/`, '_blank');
}

// –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Å–æ–±—ã—Ç–∏–π –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ DOM
document.addEventListener('DOMContentLoaded', function() {
    // –ù–∞–∑–Ω–∞—á–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–Ω–æ–ø–∫–∞–º
    document.getElementById('load-btn').addEventListener('click', loadExcelData);
    document.getElementById('save-btn').addEventListener('click', saveExcelData);
    document.getElementById('download-btn').addEventListener('click', downloadExcel);

    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    loadExcelData();
});
</script>

<style>
.handsontable {
    font-size: 14px;
    border-radius: 4px;
    overflow: hidden;
}

.handsontable th {
    background-color: #f8f9fa;
    font-weight: 600;
    color: #495057;
}

#hot {
    min-height: 400px;
}
</style>
{% endblock %}