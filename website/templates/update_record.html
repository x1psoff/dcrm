{% extends 'base.html' %}
{% block content %}
<div class="container-fluid mt-4 px-3 px-md-4">
    <div class="card">
        <div class="card-header bg-warning text-white">
            <h3>Редактирование записи #{{ current_record.id }}</h3>
        </div>
        <div class="card-body">
            <form method="POST" enctype="multipart/form-data">
                {% csrf_token %}
                
                <!-- Заказчик -->
                <div class="mb-4">
                    <div class="alert alert-info">
                        <label for="id_customer" class="form-label fw-bold">
                            <i class="bi bi-person-check-fill me-2"></i>
                            Заказчик (необязательно)
                        </label>
                        {{ form.customer }}
                        <small class="d-block mt-2">
                            <i class="bi bi-info-circle me-1"></i>
                            Выберите пользователя или оставьте пустым
                        </small>
                    </div>
                </div>
                
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label for="id_first_name" class="form-label">Индекс</label>
                        {{ form.first_name }}
                    </div>
                    <div class="col-md-6">
                        <label for="id_last_name" class="form-label">Наименование</label>
                        {{ form.last_name }}
                    </div>
                </div>
                <div class="mb-3">
                    <label for="id_telegram" class="form-label">Telegram</label>
                    {{ form.telegram }}
                </div>
                <div class="mb-3">
                    <label for="id_phone" class="form-label">Телефон</label>
                    {{ form.phone }}
                </div>
                <div class="mb-3">
                    <label for="id_address" class="form-label">Адрес</label>
                    {{ form.address }}
                </div>
                <div class="mb-3">
                    <label for="id_city" class="form-label">Город</label>
                    {{ form.city }}
                </div>
                
                <div class="mb-3">
                    <label for="id_status" class="form-label">
                        <i class="bi bi-flag me-1"></i>
                        Статус заказа
                    </label>
                    <select class="form-control" id="id_status" name="status" required>
                        <option value="">Выберите статус</option>
                        <option value="otrisovka" {% if form.status.value == 'otrisovka' %}selected{% endif %}>
                            Отрисовка
                        </option>
                        <option value="zhdem_material" {% if form.status.value == 'zhdem_material' %}selected{% endif %}>
                            Ждем прибытия материала
                        </option>
                        <option value="priekhal_v_ceh" {% if form.status.value == 'priekhal_v_ceh' %}selected{% endif %}>
                            Приехал в цех
                        </option>
                        <option value="na_raspile" {% if form.status.value == 'na_raspile' %}selected{% endif %}>
                            На распиле
                        </option>
                        <option value="zakaz_gotov" {% if form.status.value == 'zakaz_gotov' %}selected{% endif %}>
                            Заказ готов
                        </option>
                    </select>
                </div>
                <div class="mb-3">
                    <label for="id_advance" class="form-label">Аванс</label>
                    {{ form.advance }}
                </div>
                <div class="mb-3">
                    <label for="id_contract_amount" class="form-label">Сумма по договору</label>
                    {{ form.contract_amount }}
                </div>
                <div class="mb-3">
                    <label for="id_designer" class="form-label">
                        <i class="bi bi-person me-1"></i>
                        Проектировщик
                        <span id="designer-method-badge" class="badge bg-info ms-2" style="display: none;"></span>
                    </label>
                    {{ form.designer }}
                </div>
                <div class="mb-3">
                    <label for="id_designer_worker" class="form-label">
                        <i class="bi bi-palette me-1"></i>
                        Дизайнер
                        <span id="designer-worker-method-badge" class="badge bg-info ms-2" style="display: none;"></span>
                    </label>
                    {{ form.designer_worker }}
                </div>
                <div class="mb-3">
                    <label for="id_assembler_worker" class="form-label">
                        <i class="bi bi-tools me-1"></i>
                        Сборщик
                        <span id="assembler-worker-method-badge" class="badge bg-info ms-2" style="display: none;"></span>
                    </label>
                    {{ form.assembler_worker }}
                </div>
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label for="id_delivery_price" class="form-label">
                            <i class="bi bi-truck me-1"></i>
                            Цена доставки
                        </label>
                        {{ form.delivery_price }}
                    </div>
                    <div class="col-md-6">
                        <label for="id_workshop_price" class="form-label">
                            <i class="bi bi-building me-1"></i>
                            Цена цеха
                        </label>
                        {{ form.workshop_price }}
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-md-4">
                        <label for="id_designer_manual_salary" class="form-label">
                            <i class="bi bi-rulers me-1"></i>
                            Погонные метры проектировщика
                        </label>
                        {{ form.designer_manual_salary }}
                        <div class="form-text text-muted" id="designer_manual_salary_preview">Итого: —</div>
                    </div>
                    <div class="col-md-4">
                        <label for="id_designer_worker_manual_salary" class="form-label">
                            <i class="bi bi-rulers me-1"></i>
                            Погонные метры дизайнера
                        </label>
                        {{ form.designer_worker_manual_salary }}
                        <div class="form-text text-muted" id="designer_worker_manual_salary_preview">Итого: —</div>
                    </div>
                    <div class="col-md-4">
                        <label for="id_assembler_worker_manual_salary" class="form-label">
                            <i class="bi bi-rulers me-1"></i>
                            Погонные метры сборщика
                        </label>
                        {{ form.assembler_worker_manual_salary }}
                        <div class="form-text text-muted" id="assembler_worker_manual_salary_preview">Итого: —</div>
                    </div>
                </div>
                <div class="mb-3">
                    <label class="form-label">Прикрепить файл:</label>
                    <input type="file" name="file" class="form-control">
                </div>
                {% if current_record.files.all %}
                <div class="mb-3">
                    <label class="form-label">Файлы:</label>
                    <ul class="list-group">
                        {% for file in current_record.files.all %}
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <a href="{{ file.file.url }}" target="_blank">{{ file.file.name }}</a>
                            <a href="{% url 'delete_file' file.id %}" class="btn btn-sm btn-danger">Удалить</a>
                        </li>
                        {% endfor %}
                    </ul>
                </div>
                {% endif %}
                <div class="mt-4">
                    <button type="submit" class="btn btn-primary">Сохранить</button>
                    <a href="{% url 'record_detail' current_record.id %}" class="btn btn-secondary">Отмена</a>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Данные о способах зарплаты для каждого рабочего
    const workerMethods = {
        {% for worker in all_workers %}
            {{ worker.id }}: "{{ worker.method.name|default:'Не указан' }}",
        {% endfor %}
    };

    // Ставка (₽/м) для погонных метров (используем rate_per_square_meter как ₽/м для "погон")
    const workerRates = {
        {% for worker in all_workers %}
            {{ worker.id }}: "{% if worker.rate_per_square_meter is not None %}{{ worker.rate_per_square_meter }}{% else %}0{% endif %}",
        {% endfor %}
    };

    function fmtMoney(n) {
        try {
            return Number(n).toLocaleString('ru-RU', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        } catch (e) {
            return String(n);
        }
    }
    function fmtMeters(n) {
        try {
            return Number(n).toLocaleString('ru-RU', { minimumFractionDigits: 0, maximumFractionDigits: 2 });
        } catch (e) {
            return String(n);
        }
    }

    // Функция для обновления бейджа способа зарплаты
    function updateMethodBadge(selectId, badgeId) {
        const select = document.getElementById(selectId);
        const badge = document.getElementById(badgeId);
        
        if (select && badge) {
            const selectedValue = select.value;
            if (selectedValue && workerMethods[selectedValue]) {
                badge.textContent = workerMethods[selectedValue];
                badge.style.display = 'inline';
            } else {
                badge.style.display = 'none';
            }
        }
    }

    function updateMetersPreview(workerSelectId, metersInputId, previewId) {
        const workerSelect = document.getElementById(workerSelectId);
        const metersInput = document.getElementById(metersInputId);
        const preview = document.getElementById(previewId);
        if (!workerSelect || !metersInput || !preview) return;

        const workerId = workerSelect.value;
        const method = (workerMethods[workerId] || '').toLowerCase();
        const rate = parseFloat(workerRates[workerId] || '0') || 0;
        const meters = parseFloat(metersInput.value || '0') || 0;

        if (!workerId) {
            preview.textContent = 'Итого: выберите работника';
            return;
        }
        if (method && method.indexOf('погон') === -1) {
            preview.textContent = 'Итого: способ оплаты не "погонный метр"';
            return;
        }
        if (!rate) {
            preview.textContent = 'Итого: ставка не указана';
            return;
        }

        const total = rate * meters;
        preview.textContent = `Итого: ${fmtMoney(rate)} ₽/м × ${fmtMeters(meters)} м = ${fmtMoney(total)} ₽`;
    }

    // Обработчики изменения выбора рабочих
    document.getElementById('id_designer').addEventListener('change', function() {
        updateMethodBadge('id_designer', 'designer-method-badge');
        updateMetersPreview('id_designer', 'id_designer_manual_salary', 'designer_manual_salary_preview');
    });

    document.getElementById('id_designer_worker').addEventListener('change', function() {
        updateMethodBadge('id_designer_worker', 'designer-worker-method-badge');
        updateMetersPreview('id_designer_worker', 'id_designer_worker_manual_salary', 'designer_worker_manual_salary_preview');
    });

    document.getElementById('id_assembler_worker').addEventListener('change', function() {
        updateMethodBadge('id_assembler_worker', 'assembler-worker-method-badge');
        updateMetersPreview('id_assembler_worker', 'id_assembler_worker_manual_salary', 'assembler_worker_manual_salary_preview');
    });

    // Инициализация при загрузке страницы
    updateMethodBadge('id_designer', 'designer-method-badge');
    updateMethodBadge('id_designer_worker', 'designer-worker-method-badge');
    updateMethodBadge('id_assembler_worker', 'assembler-worker-method-badge');

    // Пересчет при вводе метров
    const designerMeters = document.getElementById('id_designer_manual_salary');
    if (designerMeters) {
        designerMeters.addEventListener('input', () => updateMetersPreview('id_designer', 'id_designer_manual_salary', 'designer_manual_salary_preview'));
    }
    const designerWorkerMeters = document.getElementById('id_designer_worker_manual_salary');
    if (designerWorkerMeters) {
        designerWorkerMeters.addEventListener('input', () => updateMetersPreview('id_designer_worker', 'id_designer_worker_manual_salary', 'designer_worker_manual_salary_preview'));
    }
    const assemblerMeters = document.getElementById('id_assembler_worker_manual_salary');
    if (assemblerMeters) {
        assemblerMeters.addEventListener('input', () => updateMetersPreview('id_assembler_worker', 'id_assembler_worker_manual_salary', 'assembler_worker_manual_salary_preview'));
    }

    // Начальный пересчет
    updateMetersPreview('id_designer', 'id_designer_manual_salary', 'designer_manual_salary_preview');
    updateMetersPreview('id_designer_worker', 'id_designer_worker_manual_salary', 'designer_worker_manual_salary_preview');
    updateMetersPreview('id_assembler_worker', 'id_assembler_worker_manual_salary', 'assembler_worker_manual_salary_preview');
});
</script>
{% endblock %}