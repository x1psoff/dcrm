{% extends 'base.html' %}
{% block title %}Заказчик: {{ customer.get_full_name|default:customer.username }} - Домашний очаг{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
  <!-- Хлебные крошки -->
  <nav aria-label="breadcrumb">
    <ol class="breadcrumb">
      <li class="breadcrumb-item"><a href="{% url 'home' %}">Главная</a></li>
      <li class="breadcrumb-item"><a href="{% url 'profiles_list' %}">Профили</a></li>
      <li class="breadcrumb-item active">{{ customer.get_full_name|default:customer.username }}</li>
    </ol>
  </nav>

  <!-- Информация о заказчике -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="card">
        <div class="card-header bg-primary text-white">
          <div class="d-flex align-items-center justify-content-between">
            <h3 class="mb-0">
              <i class="bi bi-person-circle me-2"></i>
              {{ customer.get_full_name|default:customer.username }}
            </h3>
            <span class="badge bg-light text-dark fs-6">
              {{ profile.user_type_display }}
            </span>
          </div>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-6">
              <p class="mb-2">
                <i class="bi bi-person me-2"></i>
                <strong>Username:</strong> {{ customer.username }}
              </p>
              {% if customer.first_name or customer.last_name %}
              <p class="mb-2">
                <i class="bi bi-person-badge me-2"></i>
                <strong>ФИО:</strong> {{ customer.first_name }} {{ customer.last_name }}
              </p>
              {% endif %}
              {% if customer.email %}
              <p class="mb-2">
                <i class="bi bi-envelope me-2"></i>
                <strong>Email:</strong> {{ customer.email }}
              </p>
              {% endif %}
            </div>
            <div class="col-md-6">
              {% if profile.telegram_id %}
              <p class="mb-2">
                <i class="bi bi-telegram me-2"></i>
                <strong>Telegram ID:</strong> {{ profile.telegram_id }}
                {% if profile.telegram_verified %}
                  <span class="badge bg-success ms-2">Подтвержден</span>
                {% else %}
                  <span class="badge bg-secondary ms-2">Не подтвержден</span>
                {% endif %}
              </p>
              {% endif %}
              <p class="mb-2">
                <i class="bi bi-calendar me-2"></i>
                <strong>Зарегистрирован:</strong> {{ customer.date_joined|date:"d.m.Y" }}
              </p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Статистика заказов -->
  <div class="row mb-4">
    <div class="col-md-4">
      <div class="card border-primary">
        <div class="card-body text-center">
          <i class="bi bi-cart-check fs-1 text-primary"></i>
          <h3 class="mt-2 mb-0">{{ total_orders }}</h3>
          <small class="text-muted">Всего заказов</small>
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card border-success">
        <div class="card-body text-center">
          <i class="bi bi-cash-stack fs-1 text-success"></i>
          <h3 class="mt-2 mb-0">{{ total_amount|floatformat:0 }} ₽</h3>
          <small class="text-muted">Общая сумма</small>
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card border-info">
        <div class="card-body text-center">
          <i class="bi bi-graph-up fs-1 text-info"></i>
          <h3 class="mt-2 mb-0">
            {% if total_orders > 0 %}
              {% widthratio total_amount 1 total_orders %}
            {% else %}
              0
            {% endif %}
            ₽
          </h3>
          <small class="text-muted">Средний чек</small>
        </div>
      </div>
    </div>
  </div>

  <!-- Заказы по статусам -->
  {% if status_counts %}
  <div class="row mb-4">
    <div class="col-12">
      <div class="card">
        <div class="card-header">
          <h5 class="mb-0">
            <i class="bi bi-pie-chart me-2"></i>
            Заказы по статусам
          </h5>
        </div>
        <div class="card-body">
          <div class="row">
            {% for status, count in status_counts.items %}
            <div class="col-md-4 mb-2">
              <div class="d-flex align-items-center">
                <span class="badge bg-secondary me-2">{{ count }}</span>
                <span>{{ status }}</span>
              </div>
            </div>
            {% endfor %}
          </div>
        </div>
      </div>
    </div>
  </div>
  {% endif %}

  <!-- Список заказов -->
  <div class="card">
    <div class="card-header">
      <h5 class="mb-0">
        <i class="bi bi-list-ul me-2"></i>
        Заказы заказчика
      </h5>
    </div>
    <div class="card-body p-0">
      {% if records %}
        <div class="table-responsive">
          <table class="table table-hover mb-0">
            <thead class="table-light">
              <tr>
                <th>№</th>
                <th>Дата</th>
                <th>Наименование</th>
                <th>Адрес</th>
                <th>Статус</th>
                <th>Сумма</th>
                <th>Работники</th>
                <th>Действия</th>
              </tr>
            </thead>
            <tbody>
              {% for record in records %}
              <tr>
                <td><strong>#{{ record.id }}</strong></td>
                <td>{{ record.created_at|date:"d.m.Y" }}</td>
                <td>
                  <strong>{{ record.last_name }}</strong><br>
                  <small class="text-muted">{{ record.first_name }}</small>
                </td>
                <td>
                  {% if record.address %}
                    <i class="bi bi-geo-alt me-1"></i>
                    {{ record.address|truncatechars:30 }}
                  {% else %}
                    <span class="text-muted">-</span>
                  {% endif %}
                </td>
                <td>
                  <span class="badge bg-info">
                    {{ record.get_status_display }}
                  </span>
                </td>
                <td>
                  {% if record.contract_amount %}
                    <strong>{{ record.contract_amount|floatformat:0 }} ₽</strong>
                  {% else %}
                    <span class="text-muted">-</span>
                  {% endif %}
                </td>
                <td>
                  <small>
                    {% if record.designer %}
                      <i class="bi bi-person me-1"></i>{{ record.designer.name|truncatechars:15 }}<br>
                    {% endif %}
                    {% if record.designer_worker %}
                      <i class="bi bi-palette me-1"></i>{{ record.designer_worker.name|truncatechars:15 }}<br>
                    {% endif %}
                    {% if record.assembler_worker %}
                      <i class="bi bi-tools me-1"></i>{{ record.assembler_worker.name|truncatechars:15 }}
                    {% endif %}
                    {% if not record.designer and not record.designer_worker and not record.assembler_worker %}
                      <span class="text-muted">Не назначены</span>
                    {% endif %}
                  </small>
                </td>
                <td>
                  <a href="{% url 'record_detail' record.id %}" class="btn btn-sm btn-primary">
                    <i class="bi bi-eye"></i>
                  </a>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% else %}
        <div class="text-center py-5">
          <i class="bi bi-inbox text-muted" style="font-size: 3rem;"></i>
          <h5 class="text-muted mt-3">Заказов нет</h5>
          <p class="text-muted">У этого заказчика пока нет заказов</p>
        </div>
      {% endif %}
    </div>
  </div>

  <div class="mt-4">
    <a href="{% url 'profiles_list' %}" class="btn btn-secondary">
      <i class="bi bi-arrow-left me-1"></i>
      Назад к списку профилей
    </a>
  </div>
</div>
{% endblock %}

